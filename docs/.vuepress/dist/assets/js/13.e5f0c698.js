(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{289:function(t,a,n){"use strict";n.r(a);var e=n(14),s=Object(e.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),a("hr"),t._v(" "),a("h2",{attrs:{id:"waf-部署方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#waf-部署方式"}},[t._v("#")]),t._v(" WAF 部署方式")]),t._v(" "),a("p",[a("img",{attrs:{src:"/image/1.png",alt:"图片描述"}}),t._v("\nJXWAF 的部署方式为反向代理，支持源代码编译部署和容器化部署，适配集群架构、Kubernetes 等多种使用场景，可以轻松实现快速部署，弹性扩展。")]),t._v(" "),a("h2",{attrs:{id:"测试环境部署-源代码部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试环境部署-源代码部署"}},[t._v("#")]),t._v(" 测试环境部署(源代码部署)")]),t._v(" "),a("h3",{attrs:{id:"环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[t._v("#")]),t._v(" 环境准备")]),t._v(" "),a("ul",[a("li",[t._v("服务器版本 Centos 7.x")]),t._v(" "),a("li",[t._v("python 版本 python2.7")]),t._v(" "),a("li",[t._v("openresty 版本 openresty-1.21.4.1")]),t._v(" "),a("li",[t._v("django 版本 1.9.2")])]),t._v(" "),a("p",[t._v("备注：如果使用不同的版本，需自行解决环境依赖等问题，官方不提供技术支持")]),t._v(" "),a("h3",{attrs:{id:"控制台部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#控制台部署"}},[t._v("#")]),t._v(" 控制台部署")]),t._v(" "),a("ol",[a("li",[t._v("# cd /opt")]),t._v(" "),a("li",[t._v("# yum install -y git")]),t._v(" "),a("li",[t._v("# git clone https://github.com/jx-sec/jxwaf-mini-server.git")]),t._v(" "),a("li",[t._v("# cd jxwaf-mini-server/")]),t._v(" "),a("li",[t._v("# sh install.sh")]),t._v(" "),a("li",[t._v("# pip install -r requirements.txt")]),t._v(" "),a("li",[t._v("# python manage.py makemigrations")]),t._v(" "),a("li",[t._v("# python manage.py migrate")]),t._v(" "),a("li",[t._v("# nohup python manage.py runserver 0.0.0.0:80 &")]),t._v(" "),a("li",[t._v("假设管理中心 IP 为 10.0.0.1,则打开网址 "),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1),t._v(" 进行注册并登陆,登陆成功后系统会自动进行初使化。")])]),t._v(" "),a("h3",{attrs:{id:"节点部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点部署"}},[t._v("#")]),t._v(" 节点部署")]),t._v(" "),a("ol",[a("li",[t._v("# cd /tmp")]),t._v(" "),a("li",[t._v("# yum install -y git")]),t._v(" "),a("li",[t._v("# git clone https://github.com/jx-sec/jxwaf.git")]),t._v(" "),a("li",[t._v("# cd jxwaf")]),t._v(" "),a("li",[t._v("# sh install_waf.sh")]),t._v(" "),a("li",[t._v("# 运行后显示类似信息即安装成功:")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("nginx: the configuration file /opt/jxwaf/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /opt/jxwaf/nginx/conf/nginx.conf test is successful\n")])])]),a("ol",[a("li",[t._v("假设管理中心 IP 为 10.0.0.1,则打开网址 "),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1),t._v(' 进行注册,注册完后登录账号,在 系统管理 -> 基础配置 页面获取"API_KEY"和"API_PASSWORD"')]),t._v(" "),a("li",[t._v("# cd tools")]),t._v(" "),a("li",[t._v("# python jxwaf_init.py --api_key=84ceb8f8-c052-4d60-9b43-b6007ba67ba7 --api_password=e5546411-4d82-48ad-a3f7-3daf0de94d19 --waf_server="),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("运行完成后，显示类似信息即安装成功")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("config file:  /opt/jxwaf/nginx/conf/jxwaf/jxwaf_config.json\nconfig result:\napi_key is 84ceb8f8-c052-4d60-9b43-b6007ba67ba7,access_secret is e5546411-4d82-48ad-a3f7-3daf0de94d19\nwaf_update_website is http://10.0.0.1/waf_update\nauth result:\ntry to connect jxwaf server auth api_key and api_password,result is True\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("# /opt/jxwaf/nginx/sbin/nginx")]),t._v(" "),a("li",[t._v("启动 openresty,openresty 会在启动或者 reload 的时候自动到 jxwaf 管理中心拉取用户配置的最新规则,之后会定期同步配置。")])]),t._v(" "),a("h2",{attrs:{id:"线上环境部署-源代码部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线上环境部署-源代码部署"}},[t._v("#")]),t._v(" 线上环境部署(源代码部署)")]),t._v(" "),a("h3",{attrs:{id:"环境准备-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备-2"}},[t._v("#")]),t._v(" 环境准备")]),t._v(" "),a("ul",[a("li",[t._v("服务器版本 Centos 7.x")]),t._v(" "),a("li",[t._v("python 版本 python2.7")]),t._v(" "),a("li",[t._v("openresty 版本 openresty-1.21.4.1")]),t._v(" "),a("li",[t._v("django 版本 1.9.2")]),t._v(" "),a("li",[t._v("Mysql/Mariadb 版本 >= 5.6")])]),t._v(" "),a("p",[t._v("备注：如果使用不同的版本，需自行解决环境依赖等问题，官方不提供技术支持")]),t._v(" "),a("h3",{attrs:{id:"控制台部署-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#控制台部署-2"}},[t._v("#")]),t._v(" 控制台部署")]),t._v(" "),a("p",[t._v("需要先部署好数据库，假设数据库地址为 192.168.1.1，端口为 3306，账号为 root，密码为 123456，数据库为 jxwaf")]),t._v(" "),a("ol",[a("li",[t._v("# cd /opt")]),t._v(" "),a("li",[t._v("# yum install git -y")]),t._v(" "),a("li",[t._v("# git clone https://github.com/jx-sec/jxwaf-mini-server.git")]),t._v(" "),a("li",[t._v("# cd jxwaf-mini-server/")]),t._v(" "),a("li",[t._v("# sh install.sh")]),t._v(" "),a("li",[t._v("# pip install -r requirements.txt")]),t._v(" "),a("li",[t._v("# vim jxwaf_min_server/settings.py")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#DEBUG = True\nDEBUG = False\n#ALLOWED_HOSTS = []\nALLOWED_HOSTS = ['*']\n# Database\n# https://docs.djangoproject.com/en/1.9/ref/settings/#databases\n#DATABASES = {\n#    'default': {\n#        'ENGINE': 'django.db.backends.sqlite3',\n#        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),\n#    }\n#}\n\nDATABASES = {\n 'default': {\n     'ENGINE': 'django.db.backends.mysql',\n     'NAME': 'jxwaf',\n     'USER': 'root',\n     'PASSWORD': '123456',\n     'HOST': '192.168.1.1',\n     'PORT': '3306',\n }\n}\n")])])]),a("ol",{attrs:{start:"8"}},[a("li",[t._v("# python manage.py makemigrations")]),t._v(" "),a("li",[t._v("# python manage.py migrate")]),t._v(" "),a("li",[t._v("# sh install_jxwaf_server.sh")]),t._v(" "),a("li",[t._v("# uwsgi --ini uwsgi.ini")]),t._v(" "),a("li",[t._v("# /opt/server/nginx/sbin/nginx -t")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("nginx: the configuration file /opt/server/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /opt/server/nginx/conf/nginx.conf test is successful\n")])])]),a("ol",{attrs:{start:"13"}},[a("li",[t._v("# /opt/server/nginx/sbin/nginx")]),t._v(" "),a("li",[t._v("假设管理中心 IP 为 10.0.0.1,则打开网址 "),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1),t._v(" 进行注册并登陆,登陆成功后系统会自动进行初使化。")])]),t._v(" "),a("h3",{attrs:{id:"节点部署-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#节点部署-2"}},[t._v("#")]),t._v(" 节点部署")]),t._v(" "),a("ol",[a("li",[t._v("# cd /tmp")]),t._v(" "),a("li",[t._v("# yum install -y git")]),t._v(" "),a("li",[t._v("# git clone https://github.com/jx-sec/jxwaf.git")]),t._v(" "),a("li",[t._v("# cd jxwaf")]),t._v(" "),a("li",[t._v("# sh install_waf.sh")]),t._v(" "),a("li",[t._v("# 运行后显示类似信息即安装成功:")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("nginx: the configuration file /opt/jxwaf/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /opt/jxwaf/nginx/conf/nginx.conf test is successful\n")])])]),a("ol",[a("li",[t._v("假设管理中心 IP 为 10.0.0.1,则打开网址 "),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1),t._v(' 进行注册,注册完后登录账号,在 系统管理 -> 基础配置 页面获取"API_KEY"和"API_PASSWORD"')]),t._v(" "),a("li",[t._v("# cd tools")]),t._v(" "),a("li",[t._v("# python jxwaf_init.py --api_key=84ceb8f8-c052-4d60-9b43-b6007ba67ba7 --api_password=e5546411-4d82-48ad-a3f7-3daf0de94d19 --waf_server="),a("a",{attrs:{href:"http://10.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://10.0.0.1"),a("OutboundLink")],1)]),t._v(" "),a("li",[t._v("运行完成后，显示类似信息即安装成功")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("config file:  /opt/jxwaf/nginx/conf/jxwaf/jxwaf_config.json\nconfig result:\napi_key is 84ceb8f8-c052-4d60-9b43-b6007ba67ba7,access_secret is e5546411-4d82-48ad-a3f7-3daf0de94d19\nwaf_update_website is http://10.0.0.1/waf_update\nauth result:\ntry to connect jxwaf server auth api_key and api_password,result is True\n")])])]),a("ol",{attrs:{start:"5"}},[a("li",[t._v("# /opt/jxwaf/nginx/sbin/nginx")]),t._v(" "),a("li",[t._v("启动 openresty,openresty 会在启动或者 reload 的时候自动到 jxwaf 管理中心拉取用户配置的最新规则,之后会定期同步配置。")])]),t._v(" "),a("h2",{attrs:{id:"日志采集-报表配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#日志采集-报表配置"}},[t._v("#")]),t._v(" 日志采集&报表配置")]),t._v(" "),a("h3",{attrs:{id:"jxlog-日志采集-推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jxlog-日志采集-推荐"}},[t._v("#")]),t._v(" JXLOG 日志采集(推荐)")]),t._v(" "),a("h4",{attrs:{id:"jxlog-介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jxlog-介绍"}},[t._v("#")]),t._v(" JXLOG 介绍")]),t._v(" "),a("p",[t._v("JXLOG 为 JXWAF 官方提供的轻量级日志报表解决方案，适合大部分中小企业。\nJXLOG 由 JXLOG 客户端和 ClickHouse 数据库组成，部署架构如下:\n"),a("img",{attrs:{src:"/image/2.png",alt:"图片描述"}})]),t._v(" "),a("h4",{attrs:{id:"环境准备-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#环境准备-3"}},[t._v("#")]),t._v(" 环境准备")]),t._v(" "),a("ul",[a("li",[t._v("服务器版本 Centos 7.x")])]),t._v(" "),a("p",[t._v("备注：如果使用不同的版本，需自行解决环境依赖等问题，官方不提供技术支持")]),t._v(" "),a("h4",{attrs:{id:"jxlog-部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jxlog-部署"}},[t._v("#")]),t._v(" JXLOG 部署")]),t._v(" "),a("p",[t._v("1.安装 docker 和 docker-compose，详情可以参考 docker 官方文档：\nhttps://docs.docker.com/engine/install/centos/")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# yum install -y yum-utils\n\n#  yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n\n# yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin\n# systemctl start docker\n")])])]),a("p",[t._v("2.docker-compose 部署 jxlog")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# cd /opt\n# yum install -y git\n# git clone https://github.com/jx-sec/jxwaf-docker-file.git\n# cd jxwaf-docker-file/jxlog/\n# docker compose  up -d\n")])])]),a("p",[t._v("默认的 docker-compose.yml 文件中，clickhouse 的配置为:\n数据库: jxwaf\n账号: jxlog\n密码: jxlog\n"),a("strong",[t._v("线上环境部署需要修改 docker-compose.yml 文件中的默认密码为复杂密码")]),t._v("\n运行命令 netstat -anp|grep 9000，显示如下则运行正常")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("tcp        0      0 0.0.0.0:9000            0.0.0.0:*               LISTEN      26628/docker-proxy\ntcp6       0      0 :::9000                 :::*                    LISTEN      26634/docker-proxy\n\n")])])]),a("h4",{attrs:{id:"jxwaf-控制台报表配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jxwaf-控制台报表配置"}},[t._v("#")]),t._v(" JXWAF 控制台报表配置")]),t._v(" "),a("h3",{attrs:{id:"阿里云日志采集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#阿里云日志采集"}},[t._v("#")]),t._v(" 阿里云日志采集")]),t._v(" "),a("ol",[a("li",[t._v("登陆阿里云控制台，进入 日志服务 SLS")]),t._v(" "),a("li",[t._v("创建 Project\n"),a("img",{attrs:{src:"/image/3.png",alt:"图片描述"}})])]),t._v(" "),a("p",[t._v("3.创建 Logstore\n"),a("img",{attrs:{src:"/image/4.png",alt:"图片描述"}})]),t._v(" "),a("p",[t._v("4.安装 logtail\n"),a("img",{attrs:{src:"/image/5.png",alt:"图片描述"}}),t._v("\n选择 自定义数据插件\n"),a("img",{attrs:{src:"/6.png",alt:"图片描述"}}),t._v("\n按照说明完成安装到第四步 "),a("strong",[t._v("数据源设置")]),t._v(' ，以下提供的配置为开启 5555 端口的 tcp 接收，可自行修改端口配置 如 改为 "tcp://0.0.0.0:6666" 即开启 6666 端口\n'),a("img",{attrs:{src:"/image/7.png",alt:"图片描述"}})]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('{\n    "inputs": [\n        {\n            "detail": {\n                "ParseProtocol": "auto",\n                "Address": "tcp://0.0.0.0:5555"\n            },\n            "type": "service_syslog"\n        }\n    ],\n    "processors": [\n        {\n            "detail": {\n                "DropKeys": [\n                    "_facility_",\n                    "_hostname_",\n                    "_ip_",\n                    "_priority_",\n                    "_program_",\n                    "_severity_",\n                    "_unixtimestamp_"\n                ]\n            },\n            "type": "processor_drop"\n        },\n        {\n            "detail": {\n                "KeepSource": false,\n                "ExpandDepth": 0,\n                "ExpandConnector": "",\n                "SourceKey": "_content_",\n                "NoKeyError": true\n            },\n            "type": "processor_json"\n        }\n    ]\n}\n')])])]),a("p",[t._v("开启全局索引\n"),a("img",{attrs:{src:"/image/8.png",alt:"图片描述"}})]),t._v(" "),a("p",[t._v("5.配置索引\n进行 JXWAF 的控制台 系统管理 -> 日志配置\n"),a("img",{attrs:{src:"/image/9.png",alt:"图片描述"}}),t._v("\n配置完成后，对控制台配置的防护网站进行访问，当 SLS 接收到日志后，点击\n"),a("img",{attrs:{src:"/image/10.png",alt:"图片描述"}}),t._v("\n选择 自动生成索引，保存索引即可\n"),a("img",{attrs:{src:"/image/11.png",alt:"图片描述"}})]),t._v(" "),a("h3",{attrs:{id:"腾讯云日志采集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#腾讯云日志采集"}},[t._v("#")]),t._v(" 腾讯云日志采集")]),t._v(" "),a("p",[t._v("注意: 腾讯云日志服务提供的 API 接口不稳定，导致报表功能容易发生异常，请谨慎选择该方案。（2022 年 9 月份测试）")]),t._v(" "),a("ol",[a("li",[t._v("登陆腾讯云控制台，进入 日志服务")]),t._v(" "),a("li",[t._v("日志服务 -> 日志主题，创建日志主题\n"),a("img",{attrs:{src:"/image/12.png",alt:"图片描述"}}),t._v(" 3.新增 LogListener 采集\n"),a("img",{attrs:{src:"/image/13.png",alt:"图片描述"}}),t._v(" "),a("img",{attrs:{src:"/image/14.png",alt:"图片描述"}}),t._v(" "),a("img",{attrs:{src:"/image/15.png",alt:"图片描述"}}),t._v(" "),a("img",{attrs:{src:"/image/16.png",alt:"图片描述"}}),t._v("\n设置完成后，下载并安装 logstash，详情可以查询 logstash 的官方文档:\n"),a("a",{attrs:{href:"https://www.elastic.co/guide/en/logstash/7.17/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Logstash Reference [7.17] | Elastic"),a("OutboundLink")],1),t._v("\n详情配置文件如下，仅供参考，详情请参考腾讯云官方文档说明:")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('input {\n  tcp {\n    host => "127.0.0.1"\n    port => 5555\n    codec => json\n    ecs_compatibility => disabled\n  }\n}\n\nfilter {\n        mutate {\n        remove_field => ["@version"]\n        remove_field => ["@timestamp"]\n        remove_field => ["port"]\n}\n\n   json {\n        source => "message"\n      }\n\n}\noutput {\n        kafka {\n          topic_id => "fb88a4e9-1da4-4104-9142-b29858cb36c9"\n          bootstrap_servers => "gz-producer.cls.tencentcs.com:9096"\n          sasl_mechanism => "PLAIN"\n          security_protocol => "SASL_PLAINTEXT"\n          compression_type => "gzip"\n          sasl_jaas_config => "org.apache.kafka.common.security.plain.PlainLoginModule required username=\'bdc9bca2-4f21-4c5f-8b57-4f13c887bc14\' password=\'AKIDaVv80mFSQ7lnlUxA8rlZXGkyxg9NL42l#VvkUCnAII4dy86qNgkdIyb1CAwVrvrWy\';"\n        }\n    }\n')])])]),a("p",[t._v("当前配置为开启 5555 端口的 tcp 接收，可自行修改端口配置。 3.配置索引\n进行 JXWAF 的控制台 系统管理 -> 日志配置\n"),a("img",{attrs:{src:"/image/17.png",alt:"图片描述"}}),t._v("\n配置完成后，对控制台配置的防护网站进行访问，当腾讯云日志接收到日志后，点击\n"),a("img",{attrs:{src:"/image/18.png",alt:"图片描述"}}),t._v(" "),a("img",{attrs:{src:"/image/19.png",alt:"图片描述"}}),t._v("\n自动生成索引后点击确认即可")]),t._v(" "),a("h2",{attrs:{id:"部署效果验证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署效果验证"}},[t._v("#")]),t._v(" 部署效果验证")])])}),[],!1,null,null,null);a.default=s.exports}}]);